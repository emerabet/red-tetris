<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <body>
        <main id='board'>
            <div class="row">
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
            </div>

            <div class="row">
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
            </div>

            <div class="row">
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
            </div>

            <div class="row">
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
            </div>

            <div class="row">
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
            </div>

            <div class="row">
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
            </div>

            <div class="row">
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
            </div>

            <div class="row">
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
            </div>

            <div class="row">
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
            </div>

            <div class="row">
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
            </div>

            <div class="row">
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
            </div>

            <div class="row">
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
            </div>

            <div class="row">
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
            </div>

            <div class="row">
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
            </div>

            <div class="row">
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
                <div class="row_cell">3/10</div>
            </div>

            <div class="row">
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
                <div class="row_cell">1/10</div>
            </div>

            <div class="row">
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
                <div class="row_cell">2/10</div>
            </div>

            <div class="row">
                <div class="row_cell locked"></div>
                <div class="row_cell locked"></div>
                <div class="row_cell locked"></div>
                <div class="row_cell locked"></div>
                <div class="row_cell locked"></div>
                <div class="row_cell locked"></div>
                <div class="row_cell locked"></div>
                <div class="row_cell locked"></div>
                <div class="row_cell locked"></div>
                <div class="row_cell locked"></div>
            </div>
        </main>
        <button id='btnState' name='btnState'>Start</button>
        <button id='btnStop' name='btnStop'>Stop</button>
        <button id='btnRestart' name='btnRestart'>Restart</button>
        <script src="/socket.io/socket.io.js"></script>
        <script>
            const lookuptable = {
                '-1': 'filled locked',
                '0': 'empty',
                '1': 'filled shape-z',
                '2': 'filled shape-s',
                '3': 'filled shape-j',
                '4': 'filled shape-l',
                '5': 'filled shape-t',
                '6': 'filled shape-i',
                '7': 'filled shape-o',
            };

            var keytable = {
                32: 'space', // SPACE
                37: 'left', // LEFT
                38: 'up', // UP,
                39: 'right', // RIGHT
                40: 'down', // DOWN
            }

            const socket = io('http://localhost:4000', { 
                transports: ['websocket'],
                query: {
                    room: 'theroom',
                    pseudo: 'thepseudo'
                }
            });

            const board = document.querySelector('#board');
            const btnState = document.querySelector('#btnState');
            const btnStop = document.querySelector('#btnStop');
            const btnRestart = document.querySelector('#btnRestart');

            btnState.addEventListener('click', () => {
                socket.emit('init');
            });

            btnState.addEventListener('click', () => {
                socket.emit('init');
            });

            btnStop.addEventListener('click', () => {
                socket.emit('stop');
            });

            btnRestart.addEventListener('click', () => {
                socket.emit('restart');
            });

            function createCell(cell) {
                const state = `${lookuptable[cell]}` || 'shape-z';
                return `<div class="row_cell ${state}">2/10</div>`;
            }

            function createRow(row) {
                let el = `<div class="row">`;
                row.forEach(cell => {
                    el += createCell(cell);
                });
                el += `</div>`;
                return el;
            }

            function drawGrid(grid) {
                let el = '';
                grid.forEach(row => {
                    el += createRow(row);
                });

                board.innerHTML = el;
            }
           
            socket.on('state', (state) => {
                drawGrid(state.grid);
            });
            
            window.onkeydown = function(e) {
                const key = e.keyCode ? e.keyCode : e.which;
                const res = keytable[key];
                if (res && e.target == document.body) {
                    e.preventDefault();
                }
            }

            window.onkeyup = function(e) {
                const key = e.keyCode ? e.keyCode : e.which;
                const res = keytable[key];
                if (res) {
                    socket.emit(res);
                }
            }

        </script>
    </body>
</html>